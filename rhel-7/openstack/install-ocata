ontroller
INSTDIR=~/

yum install -y `cat $INSTDIR/openstack-ceph/rhel-7/openstack/packages01-ocata`
yum install -y `cat $INSTDIR/openstack-ceph/rhel-7/openstack/packages02`
yum install -y `cat $INSTDIR/openstack-ceph/rhel-7/openstack/packages-controller`
ip=`hostname -i`

cat  $INSTDIR/openstack-ceph/rhel-7/openstack/mariadb_openstack.ocata.cnf |sed s/192.168.200.11/$ip/g >  /etc/my.cnf.d/mariadb_openstack.cnf
systemctl enable mariadb.service
systemctl start mariadb.service
#should change
mysql_secure_installation


systemctl enable rabbitmq-server.service
systemctl start rabbitmq-server.service
rabbitmqctl add_user openstack $RABBIT_PASS
rabbitmqctl set_permissions openstack ".*" ".*" ".*"

sed s/KEYSTONE_DBPASS/"$KEYSTONE_DBPASS"/g $INSTDIR/openstack-ceph/rhel-7/openstack/openstack.db | mysql --password=$DATABASEPW

sslkey=`openssl rand -hex 10`
cat  $INSTDIR/openstack-ceph/rhel-7/openstack/memcached > /etc/sysconfig/memcached


systemctl enable memcached.service
systemctl start memcached.service


 openstack-config --set /etc/keystone/keystone.conf database connection  "mysql+pymysql://keystone:$KEYSTONE_DBPASS@$HOSTNAME/keystone"  
 openstack-config --set /etc/keystone/keystone.conf token provider fernet 


su -s /bin/sh -c "keystone-manage db_sync" keystone

keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
keystone-manage credential_setup --keystone-user keystone --keystone-group keystone


keystone-manage bootstrap --bootstrap-password $ADMIN_PASS \
  --bootstrap-admin-url http://$CONTROLLER:35357/v3/ \
  --bootstrap-internal-url http://$CONTROLLER:5000/v3/ \
  --bootstrap-public-url http://$CONTROLLER:5000/v3/ \
  --bootstrap-region-id RegionOne

sed s/"\#ServerName.*"/"ServerName $HOSTNAME"/g -i /etc/httpd/conf/httpd.conf
ln -s /usr/share/keystone/wsgi-keystone.conf /etc/httpd/conf.d/                  


systemctl enable httpd.service
systemctl start httpd.service


 export OS_USERNAME=admin
 export OS_PASSWORD=$ADMIN_PASS
 export OS_PROJECT_NAME=admin
 export OS_USER_DOMAIN_NAME=Default
 export OS_PROJECT_DOMAIN_NAME=Default
 export OS_AUTH_URL=http://CONTROLLER:35357/v3
 export OS_IDENTITY_API_VERSION=3

$INSTDIR/openstack-ceph/rhel-7/openstack/openstack.service.create-ocata

:
cp /etc/keystone/keystone-paste.ini /etc/keystone/keystone-paste.ini.save
sed s/" admin_token_auth "/" "/g -i /etc/keystone/keystone-paste.ini

unset OS_AUTH_URL OS_PASSWORD
openstack --os-auth-url http://$CONTROLLER:35357/v3   --os-project-domain-name default --os-user-domain-name default   --os-project-name admin --os-username admin token issue

openstack --os-auth-url http://$CONTROLLER:5000/v3   --os-project-domain-name default --os-user-domain-name default   --os-project-name demo --os-username demo token issue


sed s/GLANCE_DBPASS/"$GLANCE_DBPASS"/g $INSTDIR/openstack-ceph/rhel-7/openstack/openstack-glance.db |mysql --password=$DATABASEPW


$INSTDIR/openstack-ceph/rhel-7/openstack/openstack.glance.create-ocata

cp /etc/glance/glance-api.conf /etc/glance/glance-api.conf.save.`date +%d.%m.%y-%H.%M`

openstack-config --set /etc/glance/glance-api.conf database connection "mysql+pymysql://glance:$GLANCE_DBPASS@$HOSTNAME/glance"

openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_uri http://$HOSTNAME:5000
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_url http://$HOSTNAME:35357
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken memcached_servers $CONTROLLER:11211
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken auth_plugin password
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_domain_id default
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken user_domain_id default
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken project_name service
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken username glance
openstack-config --set /etc/glance/glance-api.conf keystone_authtoken password $GLANCE_PASS

openstack-config --set /etc/glance/glance-api.conf paste_deploy flavor keystone

openstack-config --set /etc/glance/glance-api.conf glance_store stores file,http,rbd
openstack-config --set /etc/glance/glance-api.conf glance_store default_store rbd

openstack-config --set /etc/glance/glance-api.conf client.images keyring /etc/ceph/ceph.client.glance.keyring

#openstack-config --set /etc/glance/glance-api.conf DEFAULT rbd_store_user glance
#openstack-config --set /etc/glance/glance-api.conf DEFAULT rbd_store_pool images
#openstack-config --set /etc/glance/glance-api.conf DEFAULT rbd_store_ceph_conf /etc/ceph/ceph.conf
#openstack-config --set /etc/glance/glance-api.conf DEFAULT image_conversion_dir $IMAGEDIR


openstack-config --set /etc/glance/glance-api.conf glance_store rbd_store_user glance
openstack-config --set /etc/glance/glance-api.conf glance_store rbd_store_pool images
openstack-config --set /etc/glance/glance-api.conf glance_store rbd_store_ceph_conf /etc/ceph/ceph.conf

openstack-config --set /etc/glance/glance-api.conf client.glance keyring /etc/ceph/ceph.client.glance.keyring

cp /etc/glance/glance-registry.conf /etc/glance/glance-registry.conf.`date +%d.%m.%y-%H.%M`
openstack-config --set  /etc/glance/glance-registry.conf database connection mysql+pymysql://glance:$GLANCE_DBPASS@$HOSTNAME/glance
openstack-config --set  /etc/glance/glance-registry.conf keystone_authtoken auth_uri http://$HOSTNAME:5000
openstack-config --set  /etc/glance/glance-registry.conf keystone_authtoken auth_url http://$HOSTNAME:35357
openstack-config --set  /etc/glance/glance-registry.conf keystone_authtoken auth_plugin password
openstack-config --set  /etc/glance/glance-registry.conf keystone_authtoken memcached_servers $CONTROLLER:11211
openstack-config --set  /etc/glance/glance-registry.conf keystone_authtoken project_domain_id default
openstack-config --set  /etc/glance/glance-registry.conf keystone_authtoken user_domain_id default
openstack-config --set  /etc/glance/glance-registry.conf keystone_authtoken project_name service
openstack-config --set  /etc/glance/glance-registry.conf keystone_authtoken username glance
openstack-config --set  /etc/glance/glance-registry.conf keystone_authtoken password $GLANCE_PASS
openstack-config --set  /etc/glance/glance-registry.conf paste_deploy flavor keystone

su -s /bin/sh -c "glance-manage db_sync" glance

systemctl enable openstack-glance-api.service openstack-glance-registry.service
systemctl start openstack-glance-api.service openstack-glance-registry.service

